<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SpotiStream – Spotify Now Playing</title>
  <style>
    :root {
      --bg: rgba(0, 0, 0, 0);
      --panel: rgba(18, 18, 18, 0.72);
      --text: #eaeaea;
      --muted: #b6bcc4;
      --accent: #1db954;
      --shadow: 0 12px 36px rgba(0, 0, 0, 0.35);
      --radius: 16px;
      --blur: 8px;
      --disc: 200px;
      --bar-h: 6px;
      --gap: 22px;
      --max-w: 1100px;
      --pad: 16px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      --title-size: 24px;
      --artist-size: 15px;
      --outline: 0px;
      --marq-s: 18s;
      --progress-width: 100%;
      --text-align: left;
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font: 600 14px/1.45 var(--font);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      overflow: hidden;
    }

    /* Panel */
    .wrap {
      width: 100%;
      height: 100%;
      box-sizing: border-box;
      padding: var(--pad);
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(var(--blur)) saturate(120%);
      background: var(--panel);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: relative;
    }

    .inner {
      width: 100%;
      max-width: var(--max-w);
      display: grid;
      gap: var(--gap);
      align-items: center;
    }

    /* Layouts + media placement */
    .layout-record.left .inner {
      grid-template-columns: var(--disc) minmax(320px, 1fr);
      grid-template-areas: "disc meta";
    }

    .layout-record.right .inner {
      grid-template-columns: minmax(320px, 1fr) var(--disc);
      grid-template-areas: "meta disc";
    }

    .layout-card.left .inner {
      grid-template-columns: var(--disc) minmax(320px, 1fr);
      grid-template-areas: "art meta";
    }

    .layout-card.right .inner {
      grid-template-columns: minmax(320px, 1fr) var(--disc);
      grid-template-areas: "meta art";
    }

    .layout-bar .inner {
      grid-template-columns: 1fr;
      grid-template-areas: "meta";
      padding: 4px 0;
    }

    .layout-stacked .inner {
      grid-template-columns: 1fr;
      grid-template-areas: "disc" "meta";
      place-items: center;
      text-align: center;
    }

    /* New Creative Layouts */
    .layout-compact .inner {
      grid-template-columns: 80px 1fr;
      grid-template-areas: "art meta";
      gap: 12px;
      padding: 8px;
    }

    .layout-compact .disc,
    .layout-compact .artbox {
      width: 80px;
      height: 80px;
    }

    .layout-compact .wrap {
      padding: 8px;
    }

    .layout-wide .inner {
      grid-template-columns: var(--disc) 1fr var(--disc);
      grid-template-areas: "art meta art2";
      gap: 32px;
    }

    .layout-wide .artbox:last-child {
      grid-area: art2;
      opacity: 0.3;
      filter: blur(2px);
    }

    .layout-split.left .inner {
      grid-template-columns: 1fr;
      grid-template-areas: "art" "meta";
      gap: 16px;
      text-align: center;
    }

    .layout-split.right .inner {
      grid-template-columns: 1fr;
      grid-template-areas: "meta" "art";
      gap: 16px;
      text-align: center;
    }

    .layout-split.center .inner {
      grid-template-columns: 1fr;
      grid-template-areas: "art" "meta";
      gap: 16px;
      text-align: center;
    }

    .layout-split.top .inner {
      grid-template-columns: 1fr;
      grid-template-areas: "art" "meta";
      gap: 16px;
      text-align: center;
    }

    .layout-split.bottom .inner {
      grid-template-columns: 1fr;
      grid-template-areas: "meta" "art";
      gap: 16px;
      text-align: center;
    }

    .layout-floating .wrap {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 300px;
      height: auto;
      backdrop-filter: blur(20px);
      z-index: 999;
    }

    .layout-floating .inner {
      width: 100%;
      max-width: none;
    }

    .layout-corner .inner {
      grid-template-columns: 60px 1fr;
      grid-template-areas: "art meta";
      gap: 8px;
      padding: 6px;
    }

    .layout-corner .disc,
    .layout-corner .artbox {
      width: 60px;
      height: 60px;
    }

    .layout-corner .wrap {
      padding: 6px;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 280px;
      height: auto;
    }

    .layout-ticker .inner {
      grid-template-columns: 60px 1fr;
      grid-template-areas: "art meta";
      gap: 12px;
      padding: 8px 16px;
    }

    .layout-ticker .meta {
      overflow: hidden;
      white-space: nowrap;
    }

    .layout-ticker .title,
    .layout-ticker .artist {
      display: inline-block;
      animation: scroll-left 20s linear infinite;
      white-space: nowrap;
    }

    .layout-ticker .wrap {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      border-radius: 0;
      height: auto;
    }

    @keyframes scroll-left {
      from {
        transform: translateX(100%)
      }

      to {
        transform: translateX(-100%)
      }
    }

    .layout-bar .pill,
    .layout-bar .disc,
    .layout-bar .artbox {
      display: none
    }

    .layout-compact .pill {
      display: none
    }

    .layout-corner .pill,
    .layout-corner .progress,
    .layout-corner .time {
      display: none
    }

    .layout-ticker .pill,
    .layout-ticker .progress,
    .layout-ticker .time {
      display: none
    }

    .layout-floating .pill {
      font-size: 12px;
      padding: 4px 8px;
    }

    .layout-split .pill {
      margin: 0 auto;
    }

    .meta {
      grid-area: meta;
      min-width: 0;
      display: grid;
      gap: 10px;
      align-content: center;
      z-index: 2
    }

    .disc,
    .artbox {
      z-index: 1
    }

    /* Vinyl */
    .disc {
      grid-area: disc;
      position: relative;
      width: var(--disc);
      height: var(--disc);
      border-radius: 50%;
      background:
        radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.07) 0 6%, transparent 6%),
        repeating-radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.08) 0 1px, transparent 2px 6px), #0f0f0f;
      box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.7), 0 12px 30px rgba(0, 0, 0, 0.4);
      display: grid;
      place-items: center;
      overflow: hidden;
    }

    .disc::before {
      content: "";
      position: absolute;
      inset: -18%;
      background: radial-gradient(circle at 18% 22%, rgba(255, 255, 255, 0.08), transparent 50%),
        radial-gradient(circle at 80% 78%, rgba(255, 255, 255, 0.06), transparent 50%);
      border-radius: 50%;
      z-index: 1;
      animation: sheen 9s linear infinite;
    }

    @keyframes sheen {
      from {
        transform: rotate(0)
      }

      to {
        transform: rotate(360deg)
      }
    }

    .label-img {
      width: 62%;
      height: 62%;
      border-radius: 50%;
      background: #222 center/cover no-repeat;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.35);
      position: relative;
      z-index: 2;
    }

    .label-static .label-img {
      animation: spin 9s linear infinite reverse;
    }

    .disc::after {
      content: "";
      position: absolute;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #000;
      box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.28);
      z-index: 3;
    }

    .spin .label-img,
    .spin::before {
      animation: spin 9s linear infinite
    }

    @keyframes spin {
      from {
        transform: rotate(0)
      }

      to {
        transform: rotate(360deg)
      }
    }

    .tonearm {
      position: absolute;
      right: -26px;
      top: 14px;
      width: 136px;
      height: 26px;
      transform: rotate(21deg);
      transform-origin: left center;
      pointer-events: none;
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.5));
    }

    .tonearm .arm {
      position: absolute;
      left: 0;
      top: 10px;
      width: 116px;
      height: 6px;
      background: linear-gradient(#cfcfcf, #969696);
      border-radius: 4px
    }

    .tonearm .head {
      position: absolute;
      right: 0;
      top: 6px;
      width: 22px;
      height: 14px;
      background: linear-gradient(#666, #333);
      border-radius: 3px
    }

    .tonearm .joint {
      position: absolute;
      left: -8px;
      top: 6px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #a7a7a7;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.45)
    }

    /* Card art */
    .artbox {
      grid-area: art;
      width: var(--disc);
      height: var(--disc);
      border-radius: 12px;
      overflow: hidden;
      background: #222 center/cover no-repeat;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.38);
    }

    /* Text / progress */
    .title,
    .artist {
      white-space: nowrap;
      overflow: hidden
    }

    .title {
      font-size: var(--title-size);
      font-weight: 800;
      letter-spacing: 0.2px;
      -webkit-mask-image: linear-gradient(90deg, #000 90%, transparent 100%);
      mask-image: linear-gradient(90deg, #000 90%, transparent 100%);
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5), 0 0 var(--outline) #000;
    }

    .artist {
      font-size: var(--artist-size);
      color: var(--muted);
      -webkit-mask-image: linear-gradient(90deg, #000 92%, transparent 100%);
      mask-image: linear-gradient(90deg, #000 92%, transparent 100%);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4), 0 0 var(--outline) #000;
    }

    .row {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, 0.08);
      padding: 6px 10px;
      border-radius: 999px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent)
    }

    .progress {
      height: var(--bar-h);
      border-radius: 999px;
      position: relative;
      overflow: hidden;
      background: rgba(255, 255, 255, 0.18);
      width: var(--progress-width)
    }

    .bar {
      position: absolute;
      inset: 0 100% 0 0;
      border-radius: 999px;
      background: var(--accent)
    }

    .time {
      display: flex;
      justify-content: space-between;
      font-variant-numeric: tabular-nums;
      color: var(--muted);
      width: var(--progress-width);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
    }

    /* Text alignment classes */
    .text-left .meta {
      text-align: left;
      align-items: flex-start;
    }

    .text-left .progress,
    .text-left .time {
      margin-left: 0;
      margin-right: auto;
    }

    .text-left .row {
      justify-content: flex-start;
    }

    .text-center .meta {
      text-align: center;
      align-items: center;
    }

    .text-center .progress,
    .text-center .time {
      margin: 0 auto;
    }

    .text-center .row {
      justify-content: center;
    }

    .text-right .meta {
      text-align: right;
      align-items: flex-end;
    }

    .text-right .progress,
    .text-right .time {
      margin-left: auto;
      margin-right: 0;
    }

    .text-right .row {
      justify-content: flex-end;
    }

    .next {
      font-size: 12px;
      color: var(--muted)
    }

    /* Accent styles */
    .accent-glow .dot {
      box-shadow: 0 0 12px var(--accent), 0 0 24px var(--accent);
    }

    .accent-glow .bar {
      box-shadow: 0 0 8px var(--accent);
    }

    .accent-gradient .bar {
      background: linear-gradient(90deg, var(--accent), rgba(255, 255, 255, 0.9));
    }

    .accent-pulse .dot {
      animation: pulse 2s ease-in-out infinite;
    }

    .accent-pulse .bar {
      animation: pulse 2s ease-in-out infinite;
    }

    .accent-rainbow .bar {
      background: linear-gradient(90deg, #ff0080, #ff8000, #ffff00, #80ff00, #00ff80, #0080ff, #8000ff);
    }

    .accent-rainbow .dot {
      background: linear-gradient(45deg, #ff0080, #ff8000, #ffff00, #80ff00, #00ff80, #0080ff, #8000ff);
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.7;
        transform: scale(1.05);
      }
    }

    /* No shadow mode */
    .no-shadow .title,
    .no-shadow .artist,
    .no-shadow .pill,
    .no-shadow .time {
      text-shadow: none !important;
    }

    .no-shadow .pill {
      box-shadow: none !important;
    }

    /* Marquee */
    .marquee {
      position: relative;
      overflow: hidden;
    }

    .marquee span {
      display: inline-block;
      padding-right: 60px;
      will-change: transform;
      animation: marquee var(--marq-s) linear infinite;
    }

    @keyframes marquee {
      from {
        transform: translateX(0)
      }

      to {
        transform: translateX(-50%)
      }
    }

    .btn {
      appearance: none;
      border: 0;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 800;
      cursor: pointer;
      background: var(--accent);
      color: #000;
      box-shadow: var(--shadow)
    }

    .setup {
      display: grid;
      gap: 12px
    }

    .field {
      display: grid;
      gap: 6px
    }

    .input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      background: rgba(0, 0, 0, 0.3);
      color: var(--text)
    }

    .hidden {
      display: none !important
    }

    .compact.wrap {
      padding: 10px 12px
    }

    .compact .inner {
      gap: 14px
    }

    .compact .title {
      --title-size: clamp(16px, 2.2vw, 20px)
    }

    .compact .artist {
      --artist-size: clamp(11px, 1.7vw, 13px)
    }

    @media (max-width:560px) {
      :root {
        --disc: 150px
      }

      .tonearm {
        display: none
      }
    }

    /* Visual Effects */
    #particles-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      width: 3px;
      height: 3px;
      background: var(--particle-color, white);
      border-radius: 50%;
      pointer-events: none;
      opacity: var(--particle-opacity, 0.8);
      animation: float-particle 20s ease-in-out infinite;
    }

    @keyframes float-particle {

      0%,
      100% {
        transform: translateY(0) translateX(0);
      }

      25% {
        transform: translateY(-30px) translateX(10px);
      }

      50% {
        transform: translateY(-60px) translateX(-5px);
      }

      75% {
        transform: translateY(-30px) translateX(-10px);
      }
    }

    .color-breathing .artbox,
    .color-breathing .disc {
      animation: breathe 4s ease-in-out infinite;
    }

    @keyframes breathe {

      0%,
      100% {
        filter: brightness(1) saturate(1);
      }

      50% {
        filter: brightness(var(--breathing-max-brightness, 1.15)) saturate(1.3);
      }
    }

    /* Dynamic breathing glow using accent color */
    .color-breathing .artbox::before,
    .color-breathing .disc::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: var(--breathing-color, var(--accent));
      opacity: 0;
      animation: breathe-glow 4s ease-in-out infinite;
      pointer-events: none;
      z-index: -1;
      filter: blur(20px);
    }

    @keyframes breathe-glow {

      0%,
      100% {
        opacity: 0;
        transform: scale(1);
      }

      50% {
        opacity: 0.4;
        transform: scale(1.1);
      }
    }

    .album-blur .artbox {
      filter: blur(2px) brightness(0.8);
      transition: filter 0.3s ease;
    }

    .album-blur:hover .artbox {
      filter: blur(0px) brightness(1);
    }

    .waveform .wrap {
      position: relative;
    }

    .waveform-container {
      position: absolute;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      height: 40px;
      z-index: 10;
    }

    .waveform-bar {
      width: 4px;
      background: var(--accent);
      border-radius: 2px;
      animation: wave-bar 1.2s ease-in-out infinite;
      box-shadow: 0 0 8px var(--accent);
    }

    .waveform-bar:nth-child(1) {
      height: 8px;
      animation-delay: 0s;
    }

    .waveform-bar:nth-child(2) {
      height: 16px;
      animation-delay: 0.1s;
    }

    .waveform-bar:nth-child(3) {
      height: 24px;
      animation-delay: 0.2s;
    }

    .waveform-bar:nth-child(4) {
      height: 32px;
      animation-delay: 0.3s;
    }

    .waveform-bar:nth-child(5) {
      height: 40px;
      animation-delay: 0.4s;
    }

    .waveform-bar:nth-child(6) {
      height: 32px;
      animation-delay: 0.5s;
    }

    .waveform-bar:nth-child(7) {
      height: 24px;
      animation-delay: 0.6s;
    }

    .waveform-bar:nth-child(8) {
      height: 16px;
      animation-delay: 0.7s;
    }

    .waveform-bar:nth-child(9) {
      height: 8px;
      animation-delay: 0.8s;
    }

    @keyframes wave-bar {

      0%,
      100% {
        transform: scaleY(0.4);
        opacity: 0.6;
      }

      50% {
        transform: scaleY(1);
        opacity: 1;
      }
    }

    /* Transitions - Enter/Exit classes */
    .trans-slide.exit {
      animation: slide-out 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    .trans-slide.enter {
      animation: slide-in 0.6s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    }

    @keyframes slide-out {
      to {
        transform: translateX(50px);
        opacity: 0;
      }
    }

    @keyframes slide-in {
      from {
        transform: translateX(50px);
        opacity: 0;
      }

      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .trans-fade.exit {
      animation: fade-out 0.6s ease forwards;
    }

    .trans-fade.enter {
      animation: fade-in 0.6s ease forwards;
    }

    @keyframes fade-out {
      to {
        opacity: 0;
      }
    }

    @keyframes fade-in {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .trans-bounce.exit {
      animation: bounce-out 0.6s ease-in forwards;
    }

    .trans-bounce.enter {
      animation: bounce-in 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes bounce-out {
      20% {
        transform: scale(0.9);
      }

      50%,
      100% {
        transform: scale(1.1);
        opacity: 0;
      }
    }

    @keyframes bounce-in {
      0% {
        opacity: 0;
        transform: scale(0.3);
      }

      50% {
        opacity: 1;
        transform: scale(1.05);
      }

      70% {
        transform: scale(0.9);
      }

      100% {
        transform: scale(1);
      }
    }

    .trans-zoom.exit {
      animation: zoom-out 0.6s ease forwards;
    }

    .trans-zoom.enter {
      animation: zoom-in 0.6s ease forwards;
    }

    @keyframes zoom-out {
      to {
        transform: scale(1.2);
        opacity: 0;
      }
    }

    @keyframes zoom-in {
      from {
        transform: scale(0.8);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .trans-flip.exit {
      animation: flip-out 0.6s ease-in forwards;
      backface-visibility: visible !important;
    }

    .trans-flip.enter {
      animation: flip-in 0.6s ease-out forwards;
      backface-visibility: visible !important;
    }

    @keyframes flip-out {
      to {
        transform: perspective(400px) rotateX(-90deg);
        opacity: 0;
      }
    }

    @keyframes flip-in {
      from {
        transform: perspective(400px) rotateX(90deg);
        opacity: 0;
      }

      to {
        transform: perspective(400px) rotateX(0);
        opacity: 1;
      }
    }

    /* Apply transition speed multiplier */
    .speed-05 .exit,
    .speed-05 .enter {
      animation-duration: 1.2s;
    }

    .speed-15 .exit,
    .speed-15 .enter {
      animation-duration: 0.4s;
    }

    .speed-20 .exit,
    .speed-20 .enter {
      animation-duration: 0.3s;
    }
  </style>
</head>

<body>
  <div id="particles-container"></div>
  <div id="card" class="wrap">
    <div id="inner" class="inner">
      <div id="disc" class="disc spin">
        <div id="labelImg" class="label-img"></div>
        <div id="tonearm" class="tonearm">
          <div class="arm"></div>
          <div class="head"></div>
          <div class="joint"></div>
        </div>
      </div>
      <div id="artbox" class="artbox hidden"></div>
      <div class="meta">
        <div id="statusRow" class="row">
          <div class="pill"><span class="dot"></span><span id="status">Paused</span></div>
        </div>
        <div id="title" class="title">Nothing playing</div>
        <div id="artist" class="artist">—</div>
        <div id="progress" class="progress" title="Progress">
          <div id="bar" class="bar"></div>
        </div>
        <div id="timeRow" class="time">
          <div id="elapsed">0:00</div>
          <div id="duration">0:00</div>
        </div>
        <div id="nextRow" class="next hidden"></div>
        <div id="setup" class="setup hidden">
          <div class="field"><label for="clientId">Spotify Client ID</label><input id="clientId" class="input"
              placeholder="paste your Client ID" /></div>
          <button id="save" class="btn">Save Client ID</button>
          <button id="connect" class="btn">Connect to Spotify</button>
          <small class="artist">Redirect URI must exactly match this page URL (ends with
            <code>/overlay.html</code>).</small>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ---------- utilities ---------- */
    const p = new URLSearchParams(location.search);
    const $ = id => document.getElementById(id);
    const root = document.documentElement.style;

    const THEMES = {
      spotify: { panel: 'rgba(18,18,18,0.72)', text: '#eaeaea', muted: '#b6bcc4', accent: '#1db954', particle: '#1db954', radius: 16, blur: 8 },
      obsdark: { panel: 'rgba(24,24,27,0.72)', text: '#e6e7ea', muted: '#9da3ad', accent: '#22d3ee', particle: '#22d3ee', radius: 14, blur: 6 },
      minimal: { panel: 'rgba(0,0,0,0.34)', text: '#ffffff', muted: '#cfcfcf', accent: '#ffffff', particle: '#ffffff', radius: 12, blur: 2, bar: 4, shadow: 0 },
      neon: { panel: 'rgba(8,10,22,0.62)', text: '#e9f0ff', muted: '#9ab0ff', accent: '#7cf4ff', particle: '#7cf4ff', radius: 14, blur: 10 },
      oldradio: { panel: 'rgba(64,50,34,0.62)', text: '#fff7e6', muted: '#eed9b7', accent: '#ffb84d', particle: '#ffb84d', radius: 12, blur: 3, bar: 4 },
      blue: { panel: 'rgba(10,24,48,0.55)', text: '#e6f0ff', muted: '#a9c1ff', accent: '#4da3ff', particle: '#4da3ff', radius: 16, blur: 8 },
      red: { panel: 'rgba(48,12,18,0.52)', text: '#ffeaea', muted: '#ffb3b3', accent: '#ff4d4d', particle: '#ff4d4d', radius: 16, blur: 8 },
      yellow: { panel: 'rgba(48,40,12,0.52)', text: '#fff9db', muted: '#ffe7a3', accent: '#ffd43b', particle: '#ffd43b', radius: 16, blur: 8 },
      slate: { panel: 'rgba(0,0,0,0.55)', text: '#ffffff', muted: '#c7c7c7', accent: '#1db954', particle: '#ffffff', radius: 16, blur: 6 },
      twitch: { panel: 'rgba(16,12,26,0.66)', text: '#ede9fe', muted: '#c4b5fd', accent: '#9146FF', particle: '#9146FF', radius: 16, blur: 8 },
      ytred: { panel: 'rgba(26,8,8,0.66)', text: '#ffecec', muted: '#ffb4b4', accent: '#FF0033', particle: '#FF0033', radius: 16, blur: 8 },
      aqua: { panel: 'rgba(10,24,24,0.55)', text: '#e6fffb', muted: '#a8fff2', accent: '#12d6c5', particle: '#12d6c5', radius: 16, blur: 8 },
      cyber: { panel: 'rgba(6,8,18,0.62)', text: '#d9f2ff', muted: '#8dd6ff', accent: '#00ffe1', particle: '#00ffe1', radius: 16, blur: 10 },
      cyberpunk: { panel: 'rgba(0,0,20,0.9)', text: '#00ffff', muted: '#0099cc', accent: '#ff0080', particle: '#00ffff', radius: 16, blur: 10 },
      pastel: { panel: 'rgba(28,25,23,0.45)', text: '#fff7ed', muted: '#fed7aa', accent: '#f9a8d4', particle: '#f9a8d4', radius: 18, blur: 6 },
      gaming: { panel: 'rgba(0,0,0,0.85)', text: '#00ff88', muted: '#66ffaa', accent: '#ff0066', particle: '#00ff88', radius: 16, blur: 12 },
      lofi: { panel: 'rgba(42,24,16,0.6)', text: '#f4e4c1', muted: '#d4b896', accent: '#e67e22', particle: '#f4e4c1', radius: 20, blur: 4 },
      retro: { panel: 'rgba(26,10,42,0.7)', text: '#ff6ec7', muted: '#c77dff', accent: '#7209b7', particle: '#ff6ec7', radius: 12, blur: 6 },
      elegant: { panel: 'rgba(248,249,250,0.9)', text: '#1a202c', muted: '#4a5568', accent: '#3182ce', particle: '#3182ce', radius: 18, blur: 8 },
      party: { panel: 'rgba(0,0,0,0.8)', text: '#ffffff', muted: '#cccccc', accent: '#ff1493', particle: '#ff1493', radius: 16, blur: 10 },
      cozy: { panel: 'rgba(45,24,16,0.65)', text: '#f7e6d3', muted: '#d4b896', accent: '#cd853f', particle: '#f7e6d3', radius: 16, blur: 6 },
      focus: { panel: 'rgba(0,0,0,0.3)', text: '#e2e8f0', muted: '#a0aec0', accent: '#4299e1', particle: '#4299e1', radius: 8, blur: 2 },
      sunset: { panel: 'rgba(255,94,77,0.2)', text: '#2d3748', muted: '#4a5568', accent: '#ed8936', particle: '#ed8936', radius: 16, blur: 8 },
      ocean: { panel: 'rgba(0,119,190,0.3)', text: '#ffffff', muted: '#b3d9ff', accent: '#00d4ff', particle: '#00d4ff', radius: 16, blur: 8 },
      forest: { panel: 'rgba(34,139,34,0.3)', text: '#f0fff0', muted: '#98fb98', accent: '#32cd32', particle: '#98fb98', radius: 16, blur: 6 },
      midnight: { panel: 'rgba(25,25,112,0.4)', text: '#e6e6fa', muted: '#c5c5ff', accent: '#9370db', particle: '#c5c5ff', radius: 16, blur: 10 },
      aurora: { panel: 'rgba(0,100,100,0.3)', text: '#f0ffff', muted: '#afeeee', accent: '#40e0d0', particle: '#40e0d0', radius: 18, blur: 8 },
      gradient: { panel: 'linear-gradient(135deg, rgba(255,0,150,0.3), rgba(0,204,255,0.3))', text: '#ffffff', muted: '#e0e0e0', accent: '#ff6b9d', particle: '#ff6b9d', radius: 16, blur: 8 },
      monochrome: { panel: 'rgba(0,0,0,0.2)', text: '#ffffff', muted: '#888888', accent: '#ffffff', particle: '#888888', radius: 4, blur: 0, shadow: 0 }
    };
    const FONTS = {
      inter: 'https://fonts.googleapis.com/css2?family=Inter:wght@600;800&display=swap',
      rubik: 'https://fonts.googleapis.com/css2?family=Rubik:wght@600;800&display=swap',
      montserrat: 'https://fonts.googleapis.com/css2?family=Montserrat:wght@600;800&display=swap',
      poppins: 'https://fonts.googleapis.com/css2?family=Poppins:wght@600;800&display=swap',
      firasans: 'https://fonts.googleapis.com/css2?family=Fira+Sans:wght@600;800&display=swap'
    };
    const getBool = (key, def = true) => { const v = p.get(key); if (v === null) return def; return !(v === '0' || v === 'false' || v === 'off'); };
    const applyVars = v => {
      if (!v) return;
      if (v.panel) root.setProperty('--panel', v.panel); if (v.text) root.setProperty('--text', v.text);
      if (v.muted) root.setProperty('--muted', v.muted); if (v.accent) root.setProperty('--accent', v.accent);
      if (v.particle) root.setProperty('--particle-color', v.particle);
      if (v.radius != null) root.setProperty('--radius', v.radius + 'px'); if (v.blur != null) root.setProperty('--blur', v.blur + 'px');
      if (v.bar != null) root.setProperty('--bar-h', v.bar + 'px'); if (v.shadow === 0) root.setProperty('--shadow', 'none');
    };
    const applyFont = name => {
      if (!name) return; const href = FONTS[name.toLowerCase()]; if (href) {
        const link = document.createElement('link'); link.rel = 'stylesheet'; link.href = href; document.head.appendChild(link);
        const fam = { inter: '"Inter"', rubik: '"Rubik"', montserrat: '"Montserrat"', poppins: '"Poppins"', firasans: '"Fira Sans"' }[name.toLowerCase()];
        if (fam) root.setProperty('--font', `${fam}, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`);
      }
    };

    /* ---------- layout + theme ---------- */
    const layout = (p.get('layout') || 'record').toLowerCase();
    const align = (p.get('align') || 'left').toLowerCase();
    document.body.className = `layout-${layout} ${align}`;
    applyVars(THEMES[(p.get('theme') || 'spotify').toLowerCase()]);

    const discEl = $('disc'), artbox = $('artbox'), tonearm = $('tonearm');

    if (layout === 'card') {
      discEl.style.display = 'none';
      artbox.classList.remove('hidden');
    }
    if (layout === 'compact' || layout === 'corner' || layout === 'ticker' || layout === 'split' || layout === 'floating') {
      discEl.style.display = 'none';
      artbox.classList.remove('hidden');
    }
    if (layout === 'wide') {
      discEl.style.display = 'none';
      artbox.classList.remove('hidden');
      const artbox2 = artbox.cloneNode(true);
      artbox2.id = 'artbox2';
      artbox.parentNode.appendChild(artbox2);
    }
    if (layout !== 'record') {
      tonearm.style.display = 'none';
    }

    /* overrides */
    const map = { accent: '--accent', panel: '--panel', text: '--text', muted: '--muted' };
    for (const [k, css] of Object.entries(map)) { const v = p.get(k); if (v) root.setProperty(css, v); }
    if (p.get('radius')) root.setProperty('--radius', p.get('radius') + 'px');
    if (p.get('blur')) root.setProperty('--blur', p.get('blur') + 'px');
    if (p.get('bar')) root.setProperty('--bar-h', p.get('bar') + 'px');
    if (p.get('disc') || p.get('art')) root.setProperty('--disc', (p.get('disc') || p.get('art')) + 'px');
    if (p.get('pad')) root.setProperty('--pad', p.get('pad') + 'px');
    if (p.get('shadow') === '0') root.setProperty('--shadow', 'none');
    if (p.get('outline')) root.setProperty('--outline', p.get('outline') + 'px');
    if (p.get('marq')) root.setProperty('--marq-s', p.get('marq') + 's');
    if (p.get('progresswidth')) root.setProperty('--progress-width', p.get('progresswidth') + '%');
    if (p.get('titlesize')) root.setProperty('--title-size', p.get('titlesize') + 'px');
    if (p.get('artistsize')) root.setProperty('--artist-size', p.get('artistsize') + 'px');


    if (getBool('compact', false)) $('card').classList.add('compact');
    if ((p.get('label') || '') === 'static') discEl.classList.add('label-static');
    if (!getBool('tonearm', true)) tonearm.style.display = 'none';

    if (getBool('transparent', false)) {
      root.setProperty('--panel', 'rgba(0,0,0,0)');
      root.setProperty('--blur', '0px'); root.setProperty('--shadow', 'none'); root.setProperty('--radius', '0px');
    }
    applyFont(p.get('font'));

    /* text alignment */
    const textAlign = p.get('textalign') || 'auto';
    const mediaAlign = align;

    if (textAlign === 'auto') {
      if (layout === 'stacked') {
        document.body.classList.add('text-center');
      } else if (layout === 'bar') {
        document.body.classList.add('text-left');
      } else if (mediaAlign === 'right') {
        document.body.classList.add('text-right');
      } else {
        document.body.classList.add('text-left');
      }
    } else {
      document.body.classList.add(`text-${textAlign}`);
    }

    /* accent style */
    const astyle = (p.get('accentstyle') || 'solid').toLowerCase();
    if (astyle === 'glow') document.body.classList.add('accent-glow');
    else if (astyle === 'gradient') document.body.classList.add('accent-gradient');
    else if (astyle === 'pulse') document.body.classList.add('accent-pulse');
    else if (astyle === 'rainbow') document.body.classList.add('accent-rainbow');

    if (p.get('shadow') === '0') document.body.classList.add('no-shadow');

    /* element toggles */
    const show = (id, flag) => { const n = $(id); if (!n) return; n.style.display = flag ? '' : 'none'; };
    show('statusRow', getBool('showstatus', true));
    show('progress', getBool('showprogress', true));
    show('timeRow', getBool('showtime', true));
    show('title', getBool('title', true));
    show('artist', getBool('artist', true));

    /* visual effects */
    if (getBool('particles', false)) document.body.classList.add('particles');

    // Color breathing setup
    const customBreathingColor = p.get('breathingcolor');
    const hasColorBreathing = getBool('colorbreathing', false);

    // Function to convert hex to HSL
    function hexToHSL(hex) {
      hex = hex.replace(/^#/, '');
      let r = parseInt(hex.substring(0, 2), 16) / 255;
      let g = parseInt(hex.substring(2, 4), 16) / 255;
      let b = parseInt(hex.substring(4, 6), 16) / 255;

      const max = Math.max(r, g, b);
      const min = Math.min(r, g, b);
      let h, s, l = (max + min) / 2;

      if (max === min) {
        h = s = 0;
      } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);

        switch (max) {
          case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
          case g: h = ((b - r) / d + 2) / 6; break;
          case b: h = ((r - g) / d + 4) / 6; break;
        }
      }

      return [h * 360, s * 100, l * 100];
    }

    // Function to convert HSL to hex
    function hslToHex(h, s, l) {
      s /= 100;
      l /= 100;

      const c = (1 - Math.abs(2 * l - 1)) * s;
      const x = c * (1 - Math.abs((h / 60) % 2 - 1));
      const m = l - c / 2;
      let r, g, b;

      if (h < 60) { r = c; g = x; b = 0; }
      else if (h < 120) { r = x; g = c; b = 0; }
      else if (h < 180) { r = 0; g = c; b = x; }
      else if (h < 240) { r = 0; g = x; b = c; }
      else if (h < 300) { r = x; g = 0; b = c; }
      else { r = c; g = 0; b = x; }

      const toHex = (n) => {
        const hex = Math.round((n + m) * 255).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
      };

      return '#' + toHex(r) + toHex(g) + toHex(b);
    }

    // Function to update breathing color based on current accent
    function updateBreathingColor() {
      if (!hasColorBreathing || customBreathingColor) return; // Only update if breathing is on and no custom color

      const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim();

      // Generate breathing color (shift hue by 30 degrees and increase saturation)
      if (accentColor.startsWith('#')) {
        const [h, s, l] = hexToHSL(accentColor);
        const breathingColor = hslToHex((h + 30) % 360, Math.min(s + 15, 100), l);
        root.setProperty('--breathing-color', breathingColor);
      }
    }

    if (hasColorBreathing) {
      document.body.classList.add('color-breathing');

      // Read breathing intensity as percentage (0-100)
      const breathingIntensityRaw = p.get('breathingintensity') || '100';

      // Convert percentage (0-100) to brightness multiplier (0-1.25)
      // 0% = 0x brightness (invisible), 50% = 0.625x (dim), 100% = 1.25x (bright)
      const percentage = Math.max(0, Math.min(100, parseFloat(breathingIntensityRaw))) / 100;
      const breathingIntensity = 0.0 + (percentage * 1.25);

      root.setProperty('--breathing-max-brightness', breathingIntensity.toString());

      if (customBreathingColor) {
        // Use custom breathing color if provided
        root.setProperty('--breathing-color', customBreathingColor);
      } else {
        // Calculate breathing color from current accent color
        updateBreathingColor();
      }
    }
    if (getBool('waveform', false)) {
      document.body.classList.add('waveform');
      // Create waveform bars dynamically
      const waveContainer = document.createElement('div');
      waveContainer.className = 'waveform-container';
      for (let i = 0; i < 9; i++) {
        const bar = document.createElement('div');
        bar.className = 'waveform-bar';
        waveContainer.appendChild(bar);
      }
      $('card').appendChild(waveContainer);
    }
    if (getBool('albumblur', false)) document.body.classList.add('album-blur');

    // Particle effects control
    const particlesContainer = $('particles-container');
    let particleCount = 0;

    function createParticles(intensity) {
      // Clear existing particles
      particlesContainer.innerHTML = '';

      if (intensity <= 0) return;

      // Calculate number of particles based on intensity (0-100 = 0-80 particles)
      particleCount = Math.floor(intensity * 0.8);

      // Get viewport dimensions
      const viewportWidth = window.innerWidth;
      const viewportHeight = window.innerHeight;

      // Create particles
      for (let i = 0; i < particleCount; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';

        // Random position across entire viewport
        const x = Math.random() * viewportWidth;
        const y = Math.random() * viewportHeight;

        particle.style.left = `${x}px`;
        particle.style.top = `${y}px`;

        // Vary animation duration and delay for natural effect
        const duration = 15 + Math.random() * 10; // 15-25 seconds
        const delay = Math.random() * 5; // 0-5 seconds delay

        particle.style.animationDuration = `${duration}s`;
        particle.style.animationDelay = `${delay}s`;

        particlesContainer.appendChild(particle);
      }
    }

    if (getBool('particleeffect', false)) {
      const particleCountRaw = p.get('particlecount') || '50';
      const particleOpacityRaw = p.get('particleopacity') || '80';
      const particleColorRaw = p.get('particlecolor'); // Don't default - let theme handle it

      const particleCount = Math.max(0, Math.min(100, parseFloat(particleCountRaw)));
      const particleOpacity = Math.max(0, Math.min(100, parseFloat(particleOpacityRaw))) / 100;

      root.setProperty('--particle-opacity', particleOpacity.toString());
      // Only set custom particle color if explicitly provided in URL
      if (particleColorRaw) {
        root.setProperty('--particle-color', particleColorRaw);
      }
      createParticles(particleCount);

      // Recreate particles on window resize to maintain distribution
      let resizeTimer;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(() => {
          createParticles(particleCount);
        }, 250);
      });
    }

    const transEffect = p.get('transition') || 'none';
    const animSpeed = parseFloat(p.get('animspeed') || '1');

    // Apply speed class if not 1
    if (animSpeed < 0.8) document.body.classList.add('speed-05');
    else if (animSpeed > 1.8) document.body.classList.add('speed-20');
    else if (animSpeed > 1.2) document.body.classList.add('speed-15');


    const nextParam = p.get('next'); const showNext = (nextParam === '1') || (nextParam === null && layout === 'stacked');
    show('nextRow', showNext);

    const scrollOn = getBool('scroll', true);
    const spinOn = getBool('spin', true);
    const autoAccent = getBool('autoaccent', false);

    /* ---------- Spotify auth + data ---------- */
    const SCOPES = ['user-read-playback-state', 'user-read-currently-playing'];
    const TOKEN_URL = 'https://accounts.spotify.com/api/token';
    const AUTH_URL = 'https://accounts.spotify.com/authorize';
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    const titleEl = $('title'), artistEl = $('artist'), statusEl = $('status'),
      barEl = $('bar'), elapsedEl = $('elapsed'), durationEl = $('duration'), labelDiv = $('labelImg');

    let playing = false, progressMs = 0, durationMs = 0;
    let lastTrackId = '';
    let isTransitioning = false;

    function msToClock(ms) { ms = Math.max(0, Math.floor(ms)); const t = Math.floor(ms / 1000); const m = Math.floor(t / 60); const s = t % 60; return `${m}:${s.toString().padStart(2, '0')}`; }
    function setProgress(pct) { const c = Math.max(0, Math.min(1, pct)); barEl.style.inset = `0 ${(1 - c) * 100}% 0 0`; elapsedEl.textContent = msToClock(progressMs); durationEl.textContent = msToClock(durationMs); }
    function setStatus(t) { statusEl.textContent = t; }
    function setMarquee(el, text, enable) {
      if (!enable) { el.classList.remove('marquee'); el.textContent = text; return; }
      el.classList.remove('marquee'); el.textContent = text;
      requestAnimationFrame(() => { if (el.scrollWidth > el.clientWidth + 8) { el.classList.add('marquee'); el.innerHTML = ''; const s1 = document.createElement('span'); s1.textContent = text + '   •   '; const s2 = s1.cloneNode(true); el.appendChild(s1); el.appendChild(s2); } });
    }
    function showSetup(b) { $('setup').classList.toggle('hidden', !b); }

    function renderNothing() {
      playing = false; setMarquee($('title'), 'Nothing playing', false); setMarquee($('artist'), '—', false);
      setStatus('Paused'); durationMs = progressMs = 0; setProgress(0); discEl.classList.remove('spin');
      $('labelImg').style.backgroundImage = ''; artbox.style.backgroundImage = ''; $('nextRow').classList.add('hidden');
      lastTrackId = ''; // reset so next track triggers anim
    }

    function updateDOM(item, payload) {
      const img = (item.album?.images?.[0]?.url) || (item.album?.images?.[1]?.url) || (item.album?.images?.[2]?.url) || '';
      if (img) {
        labelDiv.style.backgroundImage = `url('${img}')`;
        artbox.style.backgroundImage = `url('${img}')`;
        const ab2 = $('artbox2'); if (ab2) ab2.style.backgroundImage = `url('${img}')`;

        if (autoAccent) { try { const im = new Image(); im.crossOrigin = 'anonymous'; im.onload = () => { const c = document.createElement('canvas'), x = c.getContext('2d'); c.width = 48; c.height = 48; x.drawImage(im, 0, 0, 48, 48); const d = x.getImageData(0, 0, 48, 48).data; let r = 0, g = 0, b = 0, n = 0; for (let i = 0; i < d.length; i += 4) { if (d[i + 3] < 12) continue; r += d[i]; g += d[i + 1]; b += d[i + 2]; n++; } if (n) { r = (r / n) | 0; g = (g / n) | 0; b = (b / n) | 0; const toHex = v => v.toString(16).padStart(2, '0'); root.setProperty('--accent', `#${toHex(r)}${toHex(g)}${toHex(b)}`); if (hasColorBreathing && !customBreathingColor) { updateBreathingColor(); } } }; im.src = img; } catch (e) { } }
      }

      const artists = (item.artists || []).map(a => a.name).join(', ');
      setMarquee(titleEl, item.name || 'Untitled', scrollOn);
      setMarquee(artistEl, artists || 'Unknown artist', scrollOn);

      playing = !!payload.is_playing; setStatus(playing ? 'Playing' : 'Paused');
      discEl.classList.toggle('spin', playing && spinOn);
      durationMs = item.duration_ms || 0; progressMs = payload.progress_ms || 0; setProgress(durationMs ? progressMs / durationMs : 0);
    }

    function renderTrack(payload) {
      const item = payload?.item; if (!item) { renderNothing(); return; }

      // Clean ID logic
      // Spotify sometimes changes IDs for same song, but usually Name+Artist is stable enough or URI
      const currentId = item.id || (item.name + (item.artists?.[0]?.name || ''));

      if (currentId !== lastTrackId) {
        // Track changed
        if (lastTrackId && transEffect !== 'none' && !isTransitioning) {
          // Transition logic
          isTransitioning = true;
          const elementsToAnimate = [discEl, artbox, $('artbox2'), titleEl, artistEl, barEl].filter(e => e && e.style.display !== 'none');

          // 1. Add Exit Class
          const transClass = `trans-${transEffect}`;
          elementsToAnimate.forEach(el => {
            el.classList.add(transClass, 'exit');
          });

          // 2. Wait for animation
          // Default 600ms, adjusted by speed
          let delay = 600;
          if (animSpeed < 0.8) delay = 1200;
          else if (animSpeed > 1.8) delay = 300;
          else if (animSpeed > 1.2) delay = 400;

          setTimeout(() => {
            // 3. Update Content (mid-transition)
            updateDOM(item, payload);
            lastTrackId = currentId;

            // 4. Remove Exit, Add Enter
            elementsToAnimate.forEach(el => {
              el.classList.remove('exit');
              el.classList.add('enter'); // triggers entry anim
            });

            // 5. Cleanup Enter class after animation finishes
            setTimeout(() => {
              elementsToAnimate.forEach(el => {
                el.classList.remove(transClass, 'enter');
              });
              isTransitioning = false;
            }, delay);

          }, delay);

          return; // Stop here, async update happens in timeout
        }

        // First load or no transition
        lastTrackId = currentId;
        updateDOM(item, payload);
      } else {
        // Same track, just update progress/status
        playing = !!payload.is_playing;
        setStatus(playing ? 'Playing' : 'Paused');
        discEl.classList.toggle('spin', playing && spinOn);
        durationMs = item.duration_ms || 0; progressMs = payload.progress_ms || 0; setProgress(durationMs ? progressMs / durationMs : 0);

        // Update rotating vinyl if needed
        // (Handled by CSS 'spin' class toggle above)
      }
    }

    /* OAuth+API storage keys */
    const K = {
      clientId: 'obs_spotify_client_id', verifier: 'obs_spotify_code_verifier',
      access: 'obs_spotify_access_token', refresh: 'obs_spotify_refresh_token', expires: 'obs_spotify_expires_at'
    };

    async function sha256(str) { const buf = new TextEncoder().encode(str); const d = await crypto.subtle.digest('SHA-256', buf); return new Uint8Array(d); }
    function base64url(bytes) { return btoa(String.fromCharCode(...bytes)).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, ''); }
    function randString(n = 64) { const a = new Uint8Array(n); crypto.getRandomValues(a); return base64url(a).slice(0, n); }

    async function fetchJSON(url, opts = {}) { const res = await fetch(url, opts); if (res.status === 204) return null; if (!res.ok) throw new Error(`HTTP ${res.status}`); return await res.json(); }
    async function refresh() {
      const cid = localStorage.getItem(K.clientId); const refreshToken = localStorage.getItem(K.refresh); if (!refreshToken || !cid) return;
      const body = new URLSearchParams({ client_id: cid, grant_type: 'refresh_token', refresh_token: refreshToken });
      try {
        const tok = await fetchJSON(TOKEN_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
        if (tok.access_token) localStorage.setItem(K.access, tok.access_token);
        if (tok.refresh_token) localStorage.setItem(K.refresh, tok.refresh_token);
        if (tok.expires_in) localStorage.setItem(K.expires, String(Date.now() + tok.expires_in * 1000 - 10000));
      } catch (e) { console.error('Refresh failed', e); setStatus('Refresh failed'); }
    }
    async function ensureToken() {
      const cid = localStorage.getItem(K.clientId);
      if (!cid) { showSetup(true); setStatus('Setup required'); return false; }
      const url = new URL(location.href); const code = url.searchParams.get('code'); const err = url.searchParams.get('error');
      if (err) { showSetup(true); setStatus('Auth error'); console.error('Spotify auth error:', err); return false; }
      if (code) {
        const verifier = localStorage.getItem(K.verifier);
        try {
          const body = new URLSearchParams({ client_id: cid, grant_type: 'authorization_code', code, redirect_uri: REDIRECT_URI, code_verifier: verifier });
          const tok = await fetchJSON(TOKEN_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body });
          if (tok.access_token) localStorage.setItem(K.access, tok.access_token);
          if (tok.refresh_token) localStorage.setItem(K.refresh, tok.refresh_token);
          if (tok.expires_in) localStorage.setItem(K.expires, String(Date.now() + tok.expires_in * 1000 - 10000));
          history.replaceState({}, '', REDIRECT_URI);
        } catch (e) { console.error(e); showSetup(true); setStatus('Token exchange failed'); return false; }
      }
      const access = localStorage.getItem(K.access); const refreshT = localStorage.getItem(K.refresh); const exp = parseInt(localStorage.getItem(K.expires) || '0', 10);
      if (!access && !refreshT) { showSetup(true); setStatus('Not connected'); return false; }
      if (Date.now() > exp) await refresh();
      return true;
    }

    async function getJSON(url) { const token = localStorage.getItem(K.access); return fetchJSON(url, { headers: { Authorization: `Bearer ${token}` } }); }
    async function getCurrentlyPlaying() { try { return await getJSON('https://api.spotify.com/v1/me/player/currently-playing'); } catch (e) { if (String(e).includes('401')) await refresh(); return null; } }
    async function getQueue() { try { return await getJSON('https://api.spotify.com/v1/me/player/queue'); } catch (e) { return null; } }

    /* setup buttons */
    function initSetup() {
      const id = $('clientId'), save = $('save'), conn = $('connect');
      id.value = localStorage.getItem(K.clientId) || '';
      save.onclick = () => { const v = id.value.trim(); if (!v) return alert('Please paste your Spotify Client ID'); localStorage.setItem(K.clientId, v); alert('Saved! Now click Connect to Spotify.'); };
      conn.onclick = async () => {
        const cid = localStorage.getItem(K.clientId); if (!cid) return alert('Save your Client ID first.');
        const verifier = randString(64); const challenge = await sha256(verifier).then(buf => base64url(buf)); localStorage.setItem(K.verifier, verifier);
        const a = new URL(AUTH_URL); a.searchParams.set('response_type', 'code'); a.searchParams.set('client_id', cid);
        a.searchParams.set('redirect_uri', REDIRECT_URI); a.searchParams.set('scope', SCOPES.join(' '));
        a.searchParams.set('code_challenge_method', 'S256'); a.searchParams.set('code_challenge', challenge);
        location.href = a.toString();
      };
    }

    /* demo mode */
    const demo = getBool('demo', false);
    function startDemo() {
      showSetup(false);
      const demoImg = 'assets/demo-albumcover.jpg';
      // Fake tracks for demo transition testing
      const tracks = [
        { name: 'alebirrabionda (demo)', artist: 'Birra & Co', img: 'assets/demo-albumcover.jpg', dur: 212000 },
        { name: 'Gigio', artist: 'Gigetto', img: 'assets/demo-albumcover2.jpg', dur: 195000 }
      ];
      let tIdx = 0;

      const loadT = () => {
        const t = tracks[tIdx];
        const payload = { item: { name: t.name, artists: [{ name: t.artist }], duration_ms: t.dur, album: { images: [{ url: t.img }] } }, is_playing: true, progress_ms: 0 };
        renderTrack(payload);
      };

      loadT();

      // Track loop
      setInterval(() => { playing = true; progressMs += 250; if (progressMs > durationMs) progressMs = 0; setProgress(progressMs / durationMs); }, 250);

      // Fake track change every 10s to test transitions
      setInterval(() => {
        tIdx = (tIdx + 1) % tracks.length;
        // We intentionally don't reset progressMs here to keep the bar moving, but in real use it would reset.
        // Actually renderTrack handles reset if ID changes.
        const t = tracks[tIdx];
        // IMPORTANT: Make sure the ID is unique so renderTrack detects change
        const payload = { item: { id: `demo-${tIdx}`, name: t.name, artists: [{ name: t.artist }], duration_ms: t.dur, album: { images: [{ url: t.img }] } }, is_playing: true, progress_ms: 1000 };
        renderTrack(payload);
      }, 10000);
    }

    /* main */
    (async function main() {
      if (astyle === 'glow') document.body.classList.add('accent-glow');
      else if (astyle === 'gradient') document.body.classList.add('accent-gradient');

      initSetup();

      if (demo) { startDemo(); return; }

      const ok = await ensureToken(); showSetup(!ok);

      setInterval(async () => { const data = await getCurrentlyPlaying(); if (!data) { renderNothing(); return; } renderTrack(data); }, 3000);
      setInterval(() => { if (playing && durationMs > 0) { progressMs += 250; if (progressMs > durationMs) progressMs = durationMs; setProgress(progressMs / durationMs); } }, 250);

      if (showNext) {
        const renderNext = async () => { try { const q = await getQueue(); const nx = q?.queue?.[0]; if (nx) { const a = (nx.artists || []).map(x => x.name).join(', '); $('nextRow').textContent = `Next: ${nx.name || 'Unknown'} — ${a || ''}`; $('nextRow').classList.remove('hidden'); } } catch (e) { } };
        renderNext(); setInterval(renderNext, 15000);
      }
    })();
  </script>
</body>

</html>
